# Entity Framework Core tools reference - .NET Core CLI

Средства интерфейса командной строки для Entity Framework Core выполняют задачи проектирования во время разработки. Например, они создают миграции, применяют миграции и создают код для модели на основе существующей базы данных. Команды — это расширение для кроссплатформенной команды dotnet , которая входит в пакет SDK для .NET Core. Эти средства работают с проектами .NET Core.

## Установка инструментов

`dotnet ef` можно установить как глобальное или локальное средство. Большинство разработчиков предпочитают устанавливать средство `dotnet ef` в качестве глобального средства, используя следующую команду:

```
dotnet tool install --global dotnet-ef
```

Обновите средство с помощью следующей команды:

```
dotnet tool update --global dotnet-ef
```

Прежде чем использовать средства для определенного проекта, необходимо добавить в него пакет `Microsoft.EntityFrameworkCore.Design`

```
dotnet add package Microsoft.EntityFrameworkCore.Design
```

## Проверка установки

Выполните следующие команды, чтобы убедиться, что средства EF Core CLI установлены правильно

```
dotnet ef
```

Выходные данные команды определяют версию используемых средств:

```
                     _/\__
               ---==/    \\
         ___  ___   |.    \|\
        | __|| __|  |  )   \\\
        | _| | _|   \_/ |  //|\\
        |___||_|       /   \\\/\\

Entity Framework Core .NET Command-line Tools 8.0.6
```

## Работа с миграциями

Добавить файл (класс) миграции с названием `<название>`, где запускаемый проект это `Web`, а проект с контекстом БД (DbContext) `Infrastructure`

Если в проекте несколько контекстов, нужно явно указать который использовать `--context <имя класса>`

Можно явно указать директорию, в которой нужно создать файл миграции `--output-dir <path>`

```
dotnet ef migrations add <название> --project src/Infrastructure/ --startup-project src/Web/ --context ApplicationDbContext --output-dir Data/Migrations
```

Удалить последнюю созданную миграцию

```
dotnet ef migrations remove --project src/Infrastructure/ --startup-project src/Web/ --context ApplicationDbContext
```

Обновить базу данных, если указать имя миграции, то обновление произойдет до указанной миграции.\
Это также работает если нужно откатить миграцию, нужно просто указать имя предыдущей миграции.

```
dotnet ef database update [имя миграции] --project src/Infrastructure/ --startup-project src/Web/ --context ApplicationDbContext
```

## Scaffolding (Reverse Engineering)

Обратная инженерия — это процесс формирования классов типов сущностей и `DbContext` класса на основе схемы базы данных. Этот процесс можно выполнить с помощью команды `dotnet ef dbcontext scaffold` средств интерфейса командной строки (CLI) .NET.

### Обязательные аргументы

Команды PMC и .NET CLI имеют два обязательных аргумента: строка подключения в базу данных и поставщик базы данных EF Core для использования.

#### Connection string

Первый аргумент команды — строка подключения к базе данных. Средства будут использовать эту строку подключения для чтения схемы базы данных.

#### Имя поставщика

Второй аргумент — это имя поставщика. Имя поставщика обычно совпадает с именем пакета NuGet поставщика. Например, для PostgreSQL используйте `Npgsql.EntityFrameworkCore.PostgreSQL`.

```
dotnet ef dbcontext scaffold <строка подключения> <имя поставщика> --project src/Infrastructure/ --startup-project src/Web/ --context ApplicationDbContext --context-dir Data --context-namespace Infrastructure.Data --output-dir src/Domain/Models --namespace Domain.Models --force
```

### Целевые каталоги и пространства имен

По умолчанию шаблоны классов сущностей и класса DbContext формируются в корневом каталоге проекта и используют пространство имен проекта.

Вы можете указать каталог, в котором формируются шаблоны классов, с помощью `--output-dir`. `--context-dir` позволяет сформировать шаблон класса DbContext в каталоге отдельно от классов типов сущностей:

```
dotnet ef dbcontext scaffold ... --context-dir Data --output-dir Models
```

По умолчанию для пространства имен будет указано корневое пространство имен и имена всех подкаталогов в корневом каталоге проекта. Однако можно переопределить пространство имен для всех выходных классов с помощью `--namespace`. Кроме того, вы можете переопределить пространство имен только для класса DbContext с помощью `--context-namespace`:

```
dotnet ef dbcontext scaffold ... --namespace Your.Namespace --context-namespace Your.DbContext.Namespace
```

### Повторяющееся формирование шаблонов

Альтернативный подход к шаблону один раз заключается в повторном создании шаблонов при каждом изменении базы данных. Это перезаписывает любой ранее шаблонный код, что означает, что любые изменения, внесенные в типы сущностей или конфигурацию EF в этом коде, будут потеряны.

По умолчанию команды EF не перезаписывают существующий код для защиты от случайной потери кода. `--force` (.NET CLI) можно использовать для принудительного перезаписи существующих файлов.